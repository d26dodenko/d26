name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹
env:
  NODE_VERSION: '18'
  DEPLOY_PATH: ${{ secrets.BEGET_DEPLOY_PATH || './' }}

jobs:
  # Ğ­Ñ‚Ğ°Ğ¿ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ°
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if package.json exists
      id: check-package
      run: |
        if [ -f "package.json" ]; then
          echo "package_exists=true" >> $GITHUB_OUTPUT
        else
          echo "package_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Node.js
      if: steps.check-package.outputs.package_exists == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION || '20' }}
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.check-package.outputs.package_exists == 'true'
      run: npm ci
    
    - name: Run linter
      if: steps.check-package.outputs.package_exists == 'true'
      run: npm run lint || echo "Linter not configured, skipping..."
    
    - name: Run tests
      if: steps.check-package.outputs.package_exists == 'true'
      run: npm test || echo "No tests or test command failed"
    
    - name: Skip tests (no package.json)
      if: steps.check-package.outputs.package_exists == 'false'
      run: echo "No package.json found, skipping tests"

  # Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ°)
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create dist folder
      run: |
        echo "Creating dist folder..."
        mkdir -p dist
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ‹Ñ…
        find . -type f \
          -not -path "./.git/*" \
          -not -path "./.github/*" \
          -not -path "./node_modules/*" \
          -not -path "./dist/*" \
          -not -name "*.test.js" \
          -not -name ".env*" \
          -exec cp --parents {} dist/ \; 2>/dev/null || true
        echo "Build completed"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Beget
  deploy:
    name: Deploy to Beget
    runs-on: ubuntu-latest
    needs: [lint-and-test, build]
    # Ğ”ĞµĞ»Ğ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ· master Ğ²ĞµÑ‚ĞºĞ¸
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
    
    - name: Check dist folder exists
      run: |
        echo "Checking dist folder..."
        if [ ! -d "dist" ]; then
          echo "âŒ dist folder not found!"
          echo "Creating empty dist folder..."
          mkdir -p dist
          # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ dist, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ
          echo "Will deploy from current directory instead"
        else
          echo "âœ… dist folder exists"
          echo "Contents of dist:"
          ls -la dist/
        fi
    
    - name: Format deploy path
      id: format-path
      run: |
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ´Ğ»Ñ Beget
        DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        
        # Ğ•ÑĞ»Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
        if [ -z "$DEPLOY_PATH" ]; then
          DEPLOY_PATH="./"
        fi
        
        # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ ./
        if [[ ! "$DEPLOY_PATH" =~ ^\./ ]]; then
          DEPLOY_PATH="./$DEPLOY_PATH"
        fi
        
        # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¿ÑƒÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° /
        if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
          DEPLOY_PATH="$DEPLOY_PATH/"
        fi
        
        echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
        echo "Final deploy path: $DEPLOY_PATH"
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.BEGET_HOST }}
        username: ${{ secrets.BEGET_USERNAME }}
        password: ${{ secrets.BEGET_PASSWORD }}
        local-dir: "./dist/"
        server-dir: ${{ env.DEPLOY_PATH }}
        exclude: |
          **/.git*
          **/.github/
          **/node_modules/
          **/*.test.js
          **/.gitignore
          **/.env*
          **/coverage/
        dangerous-clean-slate: false
        dry-run: false
    
    - name: Verify deployment
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸ“ Deployed to: ${{ env.DEPLOY_PATH }}"
        echo "ğŸŒ Site URL: http://olegdata.beget.tech"
        echo "ğŸ”„ Triggered by: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"