name: CI/CD to Beget

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
    - uses: actions/checkout@v4
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –ù–ï –ø—É—Å—Ç—ã–µ
    - name: Validate secrets before deployment
      id: validate-secrets
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Å–µ–∫—Ä–µ—Ç
        if [ -z "${{ secrets.BEGET_HOST }}" ]; then
          echo "‚ùå ERROR: BEGET_HOST is empty or not set!"
          echo "Please set it in: Settings ‚Üí Secrets ‚Üí Actions"
          echo "Value should be: server.beget.com or your domain"
          exit 1
        fi
        
        if [ -z "${{ secrets.BEGET_USERNAME }}" ]; then
          echo "‚ùå ERROR: BEGET_USERNAME is empty or not set!"
          exit 1
        fi
        
        if [ -z "${{ secrets.BEGET_PASSWORD }}" ]; then
          echo "‚ùå ERROR: BEGET_PASSWORD is empty or not set!"
          exit 1
        fi
        
        # –ï—Å–ª–∏ BEGET_DEPLOY_PATH –ø—É—Å—Ç–æ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if [ -z "${{ secrets.BEGET_DEPLOY_PATH }}" ]; then
          echo "‚ö†Ô∏è WARNING: BEGET_DEPLOY_PATH not set, using default './'"
          echo "DEPLOY_PATH=./" >> $GITHUB_ENV
        else
          echo "DEPLOY_PATH=${{ secrets.BEGET_DEPLOY_PATH }}" >> $GITHUB_ENV
        fi
        
        echo "‚úÖ All secrets are valid"
    
    # 3. –î–µ–ø–ª–æ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    - name: Deploy to Beget FTP
      if: steps.validate-secrets.outcome == 'success'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.BEGET_HOST }}
        username: ${{ secrets.BEGET_USERNAME }}
        password: ${{ secrets.BEGET_PASSWORD }}
        local-dir: "./"
        server-dir: ${{ env.DEPLOY_PATH || './' }}
        exclude: |
          **/.git*
          **/.github/
          **/README.md
          **/*.md
        dangerous-clean-slate: false
    
    # 4. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - name: Success
      if: success()
      run: |
        echo "üéâ Deployment completed!"
        echo "Site should be live now"