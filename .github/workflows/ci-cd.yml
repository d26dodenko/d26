name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
env:
  NODE_VERSION: '18'
  DEPLOY_PATH: ${{ secrets.BEGET_DEPLOY_PATH || './' }}

jobs:
  # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if package.json exists
      id: check-package
      run: |
        if [ -f "package.json" ]; then
          echo "package_exists=true" >> $GITHUB_OUTPUT
        else
          echo "package_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Node.js
      if: steps.check-package.outputs.package_exists == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION || '20' }}
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.check-package.outputs.package_exists == 'true'
      run: npm ci
    
    - name: Run linter
      if: steps.check-package.outputs.package_exists == 'true'
      run: npm run lint || echo "Linter not configured, skipping..."
    
    - name: Run tests
      if: steps.check-package.outputs.package_exists == 'true'
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if [ -d "tests" ] || ls *.test.js 2>/dev/null; then
          npm test
        else
          echo "No tests found, skipping test execution"
        fi
    
    - name: Skip tests (no package.json)
      if: steps.check-package.outputs.package_exists == 'false'
      run: echo "No package.json found, skipping tests"

  # –≠—Ç–∞–ø 2: –°–±–æ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-test  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    if: ${{ needs.lint-and-test.result == 'success' }}  # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create dist folder
      run: |
        echo "Creating dist folder..."
        mkdir -p dist
        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö
        find . -type f \
          -not -path "./.git/*" \
          -not -path "./.github/*" \
          -not -path "./node_modules/*" \
          -not -path "./dist/*" \
          -not -name "*.test.js" \
          -not -name ".env*" \
          -exec cp --parents {} dist/ \; 2>/dev/null || true
        echo "Build completed"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # –≠—Ç–∞–ø 3: –î–µ–ø–ª–æ–π –Ω–∞ Beget
  deploy:
    name: Deploy to Beget
    runs-on: ubuntu-latest
    needs: [lint-and-test, build]  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –ò —Å–±–æ—Ä–∫–∏
    # –î–µ–ª–∞–µ–º –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –∏–∑ master –≤–µ—Ç–∫–∏ –ò –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∂–æ–±—ã —É—Å–ø–µ—à–Ω—ã
    if: |
      github.ref == 'refs/heads/master' &&
      needs.lint-and-test.result == 'success' &&
      needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
    
    - name: Check dist folder exists
      run: |
        echo "Checking dist folder..."
        if [ ! -d "dist" ]; then
          echo "‚ùå dist folder not found!"
          echo "Creating empty dist folder..."
          mkdir -p dist
          # –ï—Å–ª–∏ –Ω–µ—Ç dist, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É
          echo "Will deploy from current directory instead"
        else
          echo "‚úÖ dist folder exists"
          echo "Contents of dist:"
          ls -la dist/
        fi
    
    - name: Format deploy path
      id: format-path
      run: |
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è Beget
        DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        
        # –ï—Å–ª–∏ –ø—É—Ç—å –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if [ -z "$DEPLOY_PATH" ]; then
          DEPLOY_PATH="./"
        fi
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ./
        if [[ ! "$DEPLOY_PATH" =~ ^\./ ]]; then
          DEPLOY_PATH="./$DEPLOY_PATH"
        fi
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /
        if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
          DEPLOY_PATH="$DEPLOY_PATH/"
        fi
        
        echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
        echo "Final deploy path: $DEPLOY_PATH"
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.BEGET_HOST }}
        username: ${{ secrets.BEGET_USERNAME }}
        password: ${{ secrets.BEGET_PASSWORD }}
        local-dir: "./dist/"
        server-dir: ${{ env.DEPLOY_PATH }}
        exclude: |
          **/.git*
          **/.github/
          **/node_modules/
          **/*.test.js
          **/.gitignore
          **/.env*
          **/coverage/
        dangerous-clean-slate: false
        dry-run: false
    
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üìÅ Deployed to: ${{ env.DEPLOY_PATH }}"
        echo "üåê Site URL: http://olegdata.beget.tech"
        echo "üîÑ Triggered by: ${{ github.actor }}"
        echo "üìù Commit: ${{ github.sha }}"

  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–∂–æ–±–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–µ—É–¥–∞—á–µ
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint-and-test, build]
    if: ${{ always() && (needs.lint-and-test.result == 'failure' || needs.build.result == 'failure') }}
    
    steps:
    - name: Notify about failed tests
      run: |
        echo "‚ùå CI/CD Pipeline failed!"
        echo "Test job result: ${{ needs.lint-and-test.result }}"
        echo "Build job result: ${{ needs.build.result }}"
        echo "Deploy job was skipped due to failures"