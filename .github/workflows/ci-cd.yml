name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
env:
  NODE_VERSION: '18'
  DEPLOY_PATH: ${{ secrets.BEGET_DEPLOY_PATH || './' }}

jobs:
  # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint || echo "Linter not configured, skipping..."
    
    - name: Run tests
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage/lcov.info
      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Codecov, —É–¥–∞–ª–∏—Ç–µ —ç—Ç–æ—Ç —à–∞–≥

  # –≠—Ç–∞–ø 2: –°–±–æ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      run: |
        echo "Building project..."
        # –ó–¥–µ—Å—å –º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
        # npm run build
        # –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
        mkdir -p dist
        cp -r src/* dist/
        echo "Build completed"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # –≠—Ç–∞–ø 3: –î–µ–ø–ª–æ–π –Ω–∞ Beget
  deploy:
    name: Deploy to Beget
    runs-on: ubuntu-latest
    needs: [lint-and-test, build]
    # –î–µ–ª–∞–µ–º –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –∏–∑ main –≤–µ—Ç–∫–∏
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
    
    - name: Prepare for deployment
      run: |
        echo "Preparing files for deployment..."
        ls -la dist/
        
        # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö
        cp -r tests/ dist/tests/ || true
        cp package.json dist/ || true
        cp README.md dist/ || true
    
    - name: Format deploy path
      id: format-path
      run: |
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è Beget
        DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å ./
        if [[ ! "$DEPLOY_PATH" =~ ^\./ ]]; then
          DEPLOY_PATH="./$DEPLOY_PATH"
        fi
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /
        if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
          DEPLOY_PATH="$DEPLOY_PATH/"
        fi
        
        echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
        echo "Final deploy path: $DEPLOY_PATH"
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.BEGET_HOST }}
        username: ${{ secrets.BEGET_USERNAME }}
        password: ${{ secrets.BEGET_PASSWORD }}
        local-dir: "./dist"
        server-dir: ${{ env.DEPLOY_PATH }}
        exclude: |
          **/.git*
          **/.github/
          **/node_modules/
          **/*.test.js
          **/.gitignore
          **/.env*
        dangerous-clean-slate: false
        dry-run: false
    
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üìÅ Deployed to: ${{ env.DEPLOY_PATH }}"
        echo "üåê Site URL: https://olegdata.beget.tech"
        echo "üîÑ Triggered by: ${{ github.actor }}"
        echo "üìù Commit: ${{ github.sha }}"

  # –≠—Ç–∞–ø 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  # notify:
  #   name: Send notifications
  #   runs-on: ubuntu-latest
  #   needs: [lint-and-test, deploy]
  #   if: always()  # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ —É–ø–∞–ª–∏
    
  #   steps:
  #   - name: Determine status
  #     id: status-check
  #     run: |
  #       if ${{ needs.lint-and-test.result == 'success' && needs.deploy.result == 'success' }}; then
  #         echo "STATUS=success" >> $GITHUB_ENV
  #         echo "EMOJI=‚úÖ" >> $GITHUB_ENV
  #         echo "MESSAGE=CI/CD pipeline completed successfully!" >> $GITHUB_ENV
  #       else
  #         echo "STATUS=failure" >> $GITHUB_ENV
  #         echo "EMOJI=‚ùå" >> $GITHUB_ENV
  #         echo "MESSAGE=CI/CD pipeline failed! Check the logs." >> $GITHUB_ENV
  #       fi
    
    # - name: Send Telegram notification
    #   uses: appleboy/telegram-action@master
    #   if: ${{ env.STATUS == 'failure' }}  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    #   with:
    #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
    #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #     message: |
    #       ${{ env.EMOJI }} ${{ env.MESSAGE }}
    #       Repository: ${{ github.repository }}
    #       Branch: ${{ github.ref }}
    #       Commit: ${{ github.sha }}
    #       Workflow: ${{ github.workflow }}
    #       URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}